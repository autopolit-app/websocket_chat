<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Secret Chat</title>
    <link href="css/bootstrap.css" rel="stylesheet">
    <style>
      .bd-placeholder-img {
        font-size: 1.125rem;
        text-anchor: middle;
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
      }

      @media (min-width: 768px) {
        .bd-placeholder-img-lg {
          font-size: 3.5rem;
        }
      }

      .alert {
        padding: 0.2rem 0.8rem;
        margin-bottom: 0.2rem;
      }

      .close {
        line-height: 0;
      }

      #chatmessage {
        height:500px;
        overflow:auto;
      }
    </style>
  </head>
<body class="bg-light">

<div class="container">
  <div class="py-3 text-center">  
    <h3>Secret Chat</h3>    
  </div>

  <!--user information-->
  <div class="row">
     <div class="col-md-12">    
      <div class="row">
        <div class="col-md-6 mb-3">      <p class="mb-2">输入昵称</p> 
          <input id="username"  type="text" class="form-control" placeholder="Your Name" value="" >
        </div>
        <!--
        <div class="col-md-4 mb-3">      <h6 class="mb-2">约定好的频道</h6> 
          <input id="channel" type="text" class="form-control"  placeholder="Channel No." value="" >
        </div>
        -->
        <div class="col-md-6 mb-3"><p class="mb-2">约定好的密码</p> 
          <input id="password" type="text" class="form-control" placeholder="Password" value="" >
        </div>    
      </div> 
  </div><!--Row END-->
  </div>  <!--Row END-->

  <!--message Area-->
  <h5 class="mb-3">聊天信息 : </h5>
  <div id="chatmessage" class="border border-success p-3 mb-3" style="word-break:break-all; word-wrap:break-all;" >
  </div>  <!--ID chatmessage END-->

  <!--Input Area-->
  <div class="input-group mb-3">
    <textarea id="message" class="border border-success form-control" placeholder="输入消息" aria-label="With textarea"></textarea>
    <button id='sendbutton' type="button" class="btn btn-success">发送消息</button>
  </div>

  <footer class="text-center">  
    <form action="upload" method="POST" enctype="application/x-www-form-urlencoded">
      <input name="fileupload" multiple="multiple" type="file" value="" />
      <button type="button" class="btn btn-secondary" onclick="upload()" >开始上传</button>
    </form>
  </footer>
</div><!--Container END-->

<script src="js/jquery-3.5.1.js"></script>
<script src="js/socket.io.js"></script>
<script src="js/bootstrap.js"></script>
<script src="js/crypto-js.js"></script>
<script>
function upload(e){
  var formData = new FormData();
  for (var i = 0; i < e.files.length; i++) {
        //注意这里必须用 【"file"+i】，如果直接【"file"】，会认为同一个文件并且覆盖，导致上传了多个一样的文件
　　    formData.append("file"+i, e.files[i]);
  }
  $.ajax({
    　　type: "POST",
  　   url: "/upload",
  　　　processData: false,
    　　 contentType: false,
    　　 data: formData,
    　　 cache: false,
    　　 success: function (data) {
      //
    } 
    });
};

function getaes(a) { //加密
    key = CryptoJS.SHA256($("#password").val()).toString().substring(1, 17)
    iv = CryptoJS.SHA256($("#password").val()).toString().substring(21, 37)
    var encrypted = CryptoJS.AES.encrypt(a, key,
        {
            iv: iv,
            mode: CryptoJS.mode.OFB,
            padding: CryptoJS.pad.Pkcs7
        });
    return encrypted.toString();
}

function getdaes(a) {//解密
    key = CryptoJS.SHA256($("#password").val()).toString().substring(1, 17)
    iv = CryptoJS.SHA256($("#password").val()).toString().substring(21, 37)
    var decrypted = CryptoJS.AES.decrypt(a, key,
        {
            iv: iv,
            mode: CryptoJS.mode.OFB,
            padding: CryptoJS.pad.Pkcs7
        });
    return decrypted.toString(CryptoJS.enc.Utf8);
}

$(function () {
    const socket = io.connect();
    const $sendbutton = $('#sendbutton');
    const $message = $('#message');
    const $chatmessage = $('#chatmessage');

    $sendbutton.click(function (e) {
        if ($message.val()!=='') {
        socket.emit('send message', getaes($("#username").val()+" : "+$message.val()));
        $message.val(''); //发送完毕后清空输入框
        };
    });

    //用户连接成功后，发送用户上线给服务器
    socket.on('connect',function(){
      socket.emit('user', '新用户已上线，但未设置用户名');      
    });

    //用户输入昵称后，把这个用户名发送给后台
    $("#username").change(function(){
      socket.emit('user', '用户修改昵称为 ：'+$("#username").val()); 
    });

    //转发服务器信息：用户上线/用户改名
    socket.on('user status',function(data){
      $chatmessage.append('<div class="alert alert-success alert-dismissible fade show">' + data.msg + '<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>');
      $('#chatmessage').scrollTop(99999999);
    });

    //从服务器端，监控用户退出
    socket.on('user exit',function(data){
      $chatmessage.append('<div class="alert alert-danger alert-dismissible fade show">' + data+ '<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>');
      $('#chatmessage').scrollTop(99999999);
    });   

    //转发新消息
    socket.on('new message', function (data) {
        $chatmessage.append('<div class="alert alert-info alert-dismissible fade show">' + getdaes(data.msg) + '<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>');
        $('#chatmessage').scrollTop(99999999);
    });

});

</script>
<script>
//等待socket回调数据后，删除自己上线的提示信息，并提示对方上线
$(function(){
	setTimeout(function () { 
    $('#chatmessage').children().remove();//删除自己登录的提示信息
    $('#chatmessage').append('<div class="alert alert-danger alert-dismissible fade show">请联系对方上线，之后消息将会出现在这里...<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>');
	}, 3000); // 延时3秒
})

</script>
</body>
</html>
